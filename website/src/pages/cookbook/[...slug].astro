---
import MarketingLayout from "@/layouts/MarketingLayout.astro";
import { getCollection, render } from "astro:content";
import { templates as allTemplates, type Template } from "@/data/templates/shared";
import * as mdxComponents from "@/components/mdx";

export async function getStaticPaths() {
	const cookbook = await getCollection("cookbook");

	return cookbook
		// Root index is rendered by `pages/cookbook/index.astro`.
		.filter((entry) => entry.id !== "index")
		.map((entry) => {
			const cleanId = entry.id.replace(/\/index$/, "");
			return {
				// Astro expects a string for rest params (it may contain `/`).
				params: { slug: cleanId },
				props: { entry },
			};
		});
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

const { title, description, templates } = entry.data as {
	title: string;
	description: string;
	templates?: string[];
};

// Build table of contents from headings (same pattern as docs)
const tableOfContents = headings
	.filter((h) => h.depth === 2 || h.depth === 3)
	.reduce((acc, h) => {
		if (h.depth === 2) {
			acc.push({ title: h.text, id: h.slug, children: [] });
		} else if (acc.length > 0) {
			acc[acc.length - 1].children.push({ title: h.text, id: h.slug, children: [] });
		}
		return acc;
	}, [] as Array<{ title: string; id: string; children: Array<{ title: string; id: string; children: never[] }> }>);

const slugPath = entry.id.replace(/\/index$/, "");
const canonicalUrl = `https://rivet.dev/cookbook/${slugPath}/`;
const skillId = slugPath.replaceAll("/", "-");

function resolveTemplates(names?: string[]): Array<Template & { githubUrl: string }> {
	if (!names?.length) return [];
	const resolved = [];
	for (const name of names) {
		const tpl = allTemplates.find((t) => t.name === name);
		if (!tpl) {
			resolved.push({
				name,
				displayName: name,
				description: "",
				tags: [],
				technologies: [],
				providers: { vercel: null },
				noFrontend: false,
				githubUrl: `https://github.com/rivet-dev/rivet/tree/main/examples/${name}`,
			} as Template & { githubUrl: string });
			continue;
		}
		resolved.push({
			...tpl,
			githubUrl: `https://github.com/rivet-dev/rivet/tree/main/examples/${tpl.name}`,
		});
	}
	return resolved;
}

const resolvedTemplates = resolveTemplates(templates);
---

<MarketingLayout
	title={`${title} - Rivet`}
	description={description}
	canonicalUrl={canonicalUrl}
>
	<main class="min-h-screen bg-black font-sans text-zinc-300 selection:bg-[#FF4500]/30 selection:text-orange-200">
		<div class="relative overflow-hidden pb-12 pt-32 md:pt-48">
			<div class="mx-auto max-w-7xl px-6">
				<div class="max-w-2xl mb-12">
					<a href="/cookbook" class="inline-flex items-center gap-2 text-xs text-zinc-500 hover:text-white transition-colors mb-6">
						‚Üê Back to Cookbooks
					</a>
					<h1 class="mb-6 text-4xl font-normal leading-[1.1] tracking-tight text-white md:text-6xl">
						{title}
					</h1>
					{description && (
						<p class="text-base leading-relaxed text-zinc-500">
							{description}
						</p>
					)}
				</div>

				{resolvedTemplates.length > 0 && (
					<div class="max-w-2xl">
						<div class="rounded-lg border border-white/10 bg-white/5 p-5">
							<div class="text-xs font-medium uppercase tracking-wider text-zinc-500">
								Working examples
							</div>
							<ul class="mt-3 space-y-1">
								{resolvedTemplates.map((tpl) => (
									<li class="text-sm">
										<a href={tpl.githubUrl} target="_blank" rel="noreferrer" class="text-white hover:text-zinc-200 transition-colors">
											{tpl.displayName}
										</a>
										<span class="text-zinc-500"> ({tpl.name})</span>
									</li>
								))}
							</ul>
							<p class="mt-3 text-xs text-zinc-500">
								If you need a reference implementation, read the raw working example code in these templates.
							</p>
						</div>
					</div>
				)}
			</div>
		</div>

		<div class="border-t border-white/10 py-12">
			<div class="mx-auto max-w-7xl px-6">
				<div class="max-w-2xl">
					<h2 class="text-2xl font-normal tracking-tight text-white mb-3">Install skill for coding agents</h2>
					<div class="relative group">
						<code id="skill-install-cmd" class="block rounded bg-white/5 border border-white/10 px-4 py-3 pr-12 font-mono text-sm text-zinc-200 select-all">npx skills add rivet-dev/skills -s {skillId}</code>
						<button
							id="copy-skill-btn"
							class="absolute right-2 top-1/2 -translate-y-1/2 rounded p-1.5 text-zinc-500 hover:text-white hover:bg-white/10 transition-colors"
							aria-label="Copy to clipboard"
						>
							<svg id="copy-icon" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
								<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
							</svg>
							<svg id="check-icon" class="h-4 w-4 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<polyline points="20 6 9 17 4 12"></polyline>
							</svg>
						</button>
					</div>
					<p class="mt-3 text-xs text-zinc-600">Supports Claude Code, Codex, Cursor, and other AI coding assistants.</p>
				</div>
			</div>
		</div>

		<div class="border-t border-white/10 py-16">
			<div class="mx-auto max-w-7xl px-6">
				<div class="flex flex-col lg:flex-row gap-12">
					<div class="flex-1 min-w-0 max-w-prose-docs">
						<article class="prose prose-invert prose-zinc max-w-none prose-headings:font-normal prose-headings:tracking-tight prose-p:text-zinc-400 prose-a:text-white prose-code:text-zinc-300">
							<Content components={mdxComponents} />
						</article>
					</div>
					{tableOfContents.length > 0 && (
						<aside class="hidden lg:block lg:w-56 flex-shrink-0">
							<nav id="cookbook-toc" class="lg:sticky lg:top-24 space-y-1">
								<ul class="space-y-1">
									{tableOfContents.map((section) => (
										<li>
											<a href={`#${section.id}`} data-toc-link={section.id} class="block text-sm text-zinc-500 hover:text-white transition-colors py-0.5">
												{section.title}
											</a>
											{section.children.length > 0 && (
												<ul class="pl-3 space-y-1">
													{section.children.map((child) => (
														<li>
															<a href={`#${child.id}`} data-toc-link={child.id} class="block text-sm text-zinc-500 hover:text-white transition-colors py-0.5">
																{child.title}
															</a>
														</li>
													))}
												</ul>
											)}
										</li>
									))}
								</ul>
							</nav>
						</aside>
					)}
				</div>
			</div>
		</div>

		<script>
			function initCopyButton() {
				const btn = document.getElementById('copy-skill-btn');
				const cmd = document.getElementById('skill-install-cmd');
				const copyIcon = document.getElementById('copy-icon');
				const checkIcon = document.getElementById('check-icon');
				if (!btn || !cmd || !copyIcon || !checkIcon) return;

				btn.addEventListener('click', () => {
					navigator.clipboard.writeText(cmd.textContent || '');
					copyIcon.classList.add('hidden');
					checkIcon.classList.remove('hidden');
					setTimeout(() => {
						copyIcon.classList.remove('hidden');
						checkIcon.classList.add('hidden');
					}, 2000);
				});
			}

			initCopyButton();
			document.addEventListener('astro:after-swap', initCopyButton);

			function initCookbookToc() {
				const tocLinks = document.querySelectorAll('[data-toc-link]');
				if (tocLinks.length === 0) return;

				const headingIds = Array.from(tocLinks).map(link => link.getAttribute('data-toc-link')!);

				function updateActiveLink() {
					const scrollTop = window.scrollY;
					let activeId = headingIds[0];

					for (const id of headingIds) {
						const el = document.getElementById(id);
						if (!el) continue;
						const style = window.getComputedStyle(el);
						const scrollMt = parseFloat(style.scrollMarginTop) || 0;
						const top = window.scrollY + el.getBoundingClientRect().top - scrollMt;
						if (scrollTop >= top - 16) {
							activeId = id;
						} else {
							break;
						}
					}

					tocLinks.forEach(link => {
						const linkId = link.getAttribute('data-toc-link');
						if (linkId === activeId) {
							link.classList.add('text-white');
							link.classList.remove('text-zinc-500');
						} else {
							link.classList.remove('text-white');
							link.classList.add('text-zinc-500');
						}
					});
				}

				window.addEventListener('scroll', updateActiveLink, { passive: true });
				updateActiveLink();
			}

			initCookbookToc();
			document.addEventListener('astro:after-swap', initCookbookToc);
		</script>
	</main>
</MarketingLayout>
