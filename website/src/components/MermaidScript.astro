---
// This script initializes Mermaid diagrams on the client
// Used with rehype-mermaid's 'pre-mermaid' strategy
---

<script>
  function looksLikeMermaid(code) {
    const firstLine = code
      .split('\n')
      .map((line) => line.trim())
      .find((line) => line.length > 0);
    if (!firstLine) return false;

    return /^(sequenceDiagram|flowchart|graph|classDiagram|stateDiagram|erDiagram|journey|gantt|pie|mindmap|timeline|gitGraph|quadrantChart|requirementDiagram|C4Context|C4Container|C4Component|C4Dynamic|C4Deployment)\b/.test(
      firstLine
    );
  }

  // Fallback for legacy MDX output where Mermaid fences are rendered as plain code blocks.
  function promoteLegacyMermaidBlocks() {
    const legacyBlocks = document.querySelectorAll('[data-code-block]');

    legacyBlocks.forEach((block) => {
      if (block.dataset.codeLang === 'mermaid') return;

      const content = block.querySelector('.p-4');
      if (!content) return;

      const code = content.textContent || '';
      if (!looksLikeMermaid(code)) return;

      const pre = document.createElement('pre');
      pre.className = 'mermaid';
      pre.textContent = code;
      block.replaceWith(pre);
    });
  }

  // Only initialize if there are mermaid diagrams on the page
  async function initMermaid() {
    promoteLegacyMermaidBlocks();

    const mermaidElements = document.querySelectorAll(
      'pre.mermaid:not(.mermaid-rendered):not(.mermaid-error)'
    );
    if (mermaidElements.length === 0) return;

    // Dynamically import mermaid only when needed
    const { default: mermaid } = await import('mermaid');

    mermaid.initialize({
      startOnLoad: false,
      theme: 'dark',
      securityLevel: 'loose',
      fontFamily: 'inherit',
    });

    // Render each mermaid diagram
    mermaidElements.forEach(async (element, index) => {
      const code = element.textContent || '';
      const id = `mermaid-${index}`;

      try {
        const { svg } = await mermaid.render(id, code);
        element.innerHTML = svg;
        element.classList.add('mermaid-rendered');
      } catch (error) {
        console.error('[Mermaid] Failed to render diagram:', error);
        element.classList.add('mermaid-error');
      }
    });
  }

  // Run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMermaid);
  } else {
    initMermaid();
  }

  // Re-run on Astro page transitions
  document.addEventListener('astro:page-load', initMermaid);
</script>

<style is:global>
  pre.mermaid {
    background: transparent !important;
    border: none !important;
    text-align: center;
  }

  pre.mermaid-rendered {
    padding: 1rem;
  }

  pre.mermaid-error {
    color: #ef4444;
    font-family: monospace;
    white-space: pre-wrap;
  }
</style>
